var debug = require('debug')('compression');
var onHeaders = require('on-headers');
var fs = require('fs-extra');
var basename = require('path').basename;
var guid = require('helper').guid;

debug = console.log;

module.exports = disk_cache;

function disk_cache (req, res, next) {

  var stream = fs.createWriteStream(__dirname + '/out/' + guid() + basename(req.baseUrl + req.path));
  var _end = res.end;
  var _write = res.write;
  var _flush = res.flush;

  res.flush = function flush () {
    if (stream) stream.flush()
    _flush.call(this);
  }

  res.write = function write (chunk, encoding) {
    console.log('write called');
    return _write.call(this, chunk, encoding);
  };

  res.end = function end (chunk, encoding) {
    console.log('end called');
    return _end.call(this, chunk, encoding);
  };

  onHeaders(res, function onResponseHeaders () {

    // compression stream
    debug('%s compression');
    console.log('creating stream');

  });

  next();
}