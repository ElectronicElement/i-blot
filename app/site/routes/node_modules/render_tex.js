var cheerio = require('cheerio');
var katex = require('katex');

module.exports = function render_tex (req, res, next) {

  var send = res.send;

  res.send = function (string) {

    var html = string instanceof Buffer ? string.toString() : string;
    var $ = cheerio.load(html, {decodeEntities: false});

    $('.katex').each(function(i, el){      

      $(el).replaceWith(katex.renderToString($(el).text(), {
        throwOnError: false
      }));

    });

    html = $.html();

    send.call(this, html);
  };

  next();  
};